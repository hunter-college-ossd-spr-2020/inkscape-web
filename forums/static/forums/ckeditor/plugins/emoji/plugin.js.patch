From a0fad0198078584ea8f563e8e50c52de90956215 Mon Sep 17 00:00:00 2001
From: Patrick Storz <eduard.braun2@gmx.de>
Date: Thu, 27 Feb 2020 00:56:10 +0100
Subject: [PATCH] ckeditor: restore emoji plugin customization (recently used
 emojis)

---
 .../forums/ckeditor/plugins/emoji/plugin.js   | 29 +++++++++++++++++--
 1 file changed, 27 insertions(+), 2 deletions(-)

diff --git a/forums/static/forums/ckeditor/plugins/emoji/plugin.js b/forums/static/forums/ckeditor/plugins/emoji/plugin.js
index 39a07ecf..3a9c8bb8 100644
--- a/forums/static/forums/ckeditor/plugins/emoji/plugin.js
+++ b/forums/static/forums/ckeditor/plugins/emoji/plugin.js
@@ -312,7 +312,12 @@
 						event: 'click',
 						listener: function( event ) {
 							if ( event.data.getTarget().data( 'cke-emoji-name' ) ) {
-								this.editor.execCommand( 'insertEmoji', { emojiText: event.data.getTarget().data( 'cke-emoji-symbol' ) } );
+								this.editor.execCommand( 'insertEmoji', {
+									emojiText: event.data.getTarget().data( 'cke-emoji-symbol' ),
+									fullname: event.data.getTarget().data( 'cke-emoji-full-name' ),
+									name: event.data.getTarget().data( 'cke-emoji-name' ),
+									title: event.data.getTarget().getAttribute( 'title' ),
+								} );
 							}
 						}
 					} );
@@ -354,7 +359,7 @@
 					}
 				},
 				getEmojiSections: function() {
-					return arrTools.reduce( this.groups, function( acc, item ) {
+					var ret = arrTools.reduce( this.groups, function( acc, item ) {
 						// If group is empty skip it.
 						if ( !item.items.length ) {
 							return acc;
@@ -362,6 +367,17 @@
 							return acc + this.getEmojiSection( item );
 						}
 					}, '', this );
+					/* Add list of recently used Emoji (for Brynn!) */
+					var recent = JSON.parse(localStorage.getItem("recentEmoji") || '[]') || [];
+					var rec = '';
+					for (var i = 0; i < recent.length; i++) {
+						var emoji = recent[i];
+						rec += '<li class="cke_emoji-item"><a draggable="false" data-cke-emoji-full-name="'+emoji.fullname+'" data-cke-emoji-name="'+emoji.name+'" data-cke-emoji-symbol="'+emoji.emojiText+'" data-cke-emoji-group="recent" data-ske-emoji-keywords="" title="'+emoji.title+'" href="#" _cke_focus="1">'+emoji.emojiText+'</a></li>';
+					}
+					if(rec) {
+						ret = '<section data-cke-emoji-group="recent"><h2 id="recent">Recently Used</h2><ul>' + rec + '</ul></section>' + ret;
+					}
+					return ret;
 				},
 				getEmojiSection: function( item ) {
 					var groupName = htmlEncode( item.name ),
@@ -647,6 +663,15 @@
 
 			editor.addCommand( 'insertEmoji', {
 				exec: function( editor, data ) {
+					var relist = [data];
+					var recent = JSON.parse(localStorage.getItem("recentEmoji") || '[]') || [];
+					for (var i = 0; i < recent.length; i++) {
+						if(recent[i].emojiText != data.emojiText && i < 12) {
+							relist.push(recent[i]);
+						}
+					}
+					console.log("Saving:", relist);
+					localStorage.setItem("recentEmoji", JSON.stringify(relist));
 					editor.insertHtml( data.emojiText );
 				}
 			} );
-- 
2.25.1.windows.1

